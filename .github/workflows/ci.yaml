name: "CI"
on: [pull_request, push]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: "3.8"
      - uses: pre-commit/action@v2.0.0

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install deps
        run: |
          pip install -e .
          pip install -r requirements-test.txt
          pip install git+https://github.com/dask/distributed@main
          pip install git+https://github.com/dask/dask@main

      ###
      # These steps are handled by fixtures but doing them here to try and improve performance
      - name: Install Kind
        uses: engineerd/setup-kind@v0.5.0
        with:
          skipClusterCreation: true
      - name: Create kind cluster
        run: |
          kind create cluster --name pytest-kind --kubeconfig=.pytest-kind/pytest-kind/kubeconfig
          KUBECONFIG=.pytest-kind/pytest-kind/kubeconfig kubectl config use-context kind-pytest-kind
      - name: Build CI Docker image
        run: |
          docker build -t dask-kubernetes:dev ./ci
          docker build -t ghcr.io/dask/dask-kubernetes-operator:latest -f dask_kubernetes/operator/deployment/Dockerfile .
      - name: Insert images into Kind
        run: |
          kind load docker-image --name pytest-kind dask-kubernetes:dev
          kind load docker-image --name pytest-kind ghcr.io/dask/dask-kubernetes-operator:latest
      #
      ##########

      - name: Run tests
        env:
          KUBECONFIG: .pytest-kind/pytest-kind/kubeconfig
        run: pytest
